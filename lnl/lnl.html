<html>
  <head>
    <title>Securing APIs LnL Notes</title>
    <style>
        h1, h2, li, p {
            font-family: "Segoe UI",Arial,sans-serif;
            font-style: normal;
        }
    </style>
  </head>
  <body>
    <img src="../logo.png"></img><br />
    <h1>Securing APIs LnL Notes</h1>

    <h2>Overview</h2>
    <ul>
      <li>Possible Title:  Securing APIs: Token-Based Authentication with OAuth 2</li>
      <li>Possible Title:  Securing REST APIs: Token-Based Authentication</li>
      <li>Possible Title:  Token-Based Authentication for Securing APIs</li>
      <li>Securing distributed systems</li>
      <li>A few different types (HTTP Basic over TLS, NTLM, OAuth 2)</li>
	  <li>Securing microservices with OAuth 2 (We don't want to require each service to have a request handler for authentication/authorization.  Overview diagram of how implicit flow works)</li>
      <li>Demo: OAuth 2.0 Implicit Grant Flow using JWT Access Tokens</li>
    </ul>
	
	<h2>Resources</h2>
    <ul>
    	<li><a href="https://dzone.com/articles/api-security-ways-to-authenticate-and-authorize">Securing APIs</a></li>
		<li><a href="https://beku8.wordpress.com/2015/03/31/configuring-spring-oauth2-with-jwt-asymmetric-rsa-keypair/">Spring OAuth2: JWT with RSA Asymmetric Key Pair</a></li>
		<li><a href="https://labs.hybris.com/2012/06/05/oauth2-the-implicit-flow-aka-as-the-client-side-flow/">Good article about Implicit Flow</a></li>
		<li><a href="https://dev.clever.com/instant-login/implicit-grant-flow">Good description of Implicit Grant Flow</a></li>
    	<li><a href="https://stormpath.com/blog/the-ultimate-guide-to-mobile-api-security">Mobile API Security</a></li>
		<li><a href="https://scotch.io/tutorials/the-ins-and-outs-of-token-based-authentication">The Ins and Outs of Token Based Authentication</a></li>
    	<li><a href="https://ponyfoo.com/articles/json-web-tokens-vs-session-cookies">JWTs vs Session Cookies</a></li>
    	<li><a href="https://stormpath.com/blog/token-authentication-scalable-user-mgmt">Token Authentication</a></li>
    	<li><a href="https://www.mobomo.com/2013/11/json-web-token-the-useful-little-standard-you-haven-t-heard-about/">JSON Web Tokens</a></li>
    	<li><a href="https://www.jsonwebtoken.io/">JWT Encoder</a></li>
    	<li><a href="http://bitoftech.net/2014/10/27/json-web-token-asp-net-web-api-2-jwt-owin-authorization-server/">Web Api JWT Auth Server</a></li>
    	<li><a href="http://www.asp.net/aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server">OWIN OAuth 2 Authorization Server Tutorial</a></li>
    </ul>

	<h2>Topics</h2>
	<ul>
	  <li>Denver/UberConf overview (Talks by Brian Sletten: Identity, Privilege)</li>
	  <li>Identity, Federated Identity</li>
	  <li>HTTP Basic alone is not secure</li>
	  <li>Privilege</li>
	  <li><a href="https://en.wikipedia.org/wiki/Confused_deputy_problem">Confused Deputy Problem</a>, and compiler system privilege example from Privilege talk at UberConf 2016</li>
	  <li>Microservices</li>
	  <li>TLS is more secure than SSL</li>
	  <li>Token-based authentication</li>
	  <li>Using tokens in the place of session IDs</li>
	  <li>It is not secure to store API keys in your JavaScript.  With a JavaScript app all requests come from the client which is the same place where all the code is stored which means if you store your API key in a JavaScript web app you might as well just print it out in big bold letters across the homepage as the whole world now has access to it through their browser’s dev tools.</li>
	  <li>Oauth 2 is not an authentication protocol, and it is not an authorization protocol.  It is a delegation protocol (Include power-of-attorney analogy) (podcast: The user delegates access to app so that it can access resources.  The resource server can still reject the request!!)</li>
	  <li>Stateless authentication with OAuth 2 and JWT</li>
	  <li>Stateless tokens</li>
	  <li>JWT / JOSE</li>
	  <li>JWT signing by Authorization Server (OAuth server) using private key.  Resource server can verify access token is valid.</li>
	  <li>JWT works by simply encoding a string made up of a small JSON object and hashing it using a secret shared between the two parties. The algorithm is configurable, but is usually HMAC SHA-256.</li>
	  <li>Passport???</li>
	  <li>Security issues with storing API key in JavaScript</li>
	  <li>Token-based credentials provide higher entropy and a more secure form of authentication and authorization than Username Password Credentials</li>
	  <li>Scopes are granted by the Authorization Server and stored in an access token.</li>
	  <li>With token-based credentials, the Identity Provider issues tokens based on an initial authentication request with username/password credentials. From then on, the app only has to send the token.</li>
	  <li>Tokens are generated for your users after they present verifiable credentials.  The initial authentication could be by username/password credentials, API keys or even tokens from another service.</li>
	  <li>Once generated, the token is attached to the user via a browser cookie or saved in local/session storage.</li>
	  <li>Using tokens in a mobile app allow you to easily and securely control which mobile devices are accessing your API.</li>
	  <li> A JWT is a compact, URL-safe, encryptable JSON object that is rapidly becoming the standard for token implementation across the web.</li>
	  <li>Libraries used by teams:  System.IdentityModel.Tokens.Jwt</li>
	  <li><a href="http://passportjs.org/">Passport</a> for front-end OAuth 2</li>
	  <li>OAuth 2 in Action, Chapter 11 "OAuth Tokens" contains a good description of the different types of tokens such as tokens that act like a handle to information in a database, and structured tokens like JWTs.</li>
	</ul>

	<h2>Identity</h2>
	<ul>
	  <li>The Identity Store (for example Active Directory) contains the user data.  An Identity Provider is a service that exposes this information.</li>
	  <li>When each service has its own request handler for performing authentication and authorization, it means each service is acting as an Identity Provider, rather than using a single Identity Provider service.  This violates the Single Responsibility Principle.</li>
	</ul>
	
	<h2>Principle of Least Privilege</h2>
	<ul>
		<li>Present overview.  Give example of service representative only being allowed to access customer data for the duration of the phone call.</li>
		<li>OAuth 2.0 Scopes:   Something like EMAIL_SERVICE is too generic.  It means the user is given too much authority.</li>
		<li>OAuth 2.0 Scopes:   More fine-grained (EMAIL_READ, EMAIL_DELETE, EMAIL_POST, EMAIL_MOVE, etc.) allows clients to use minimal authority to access the user's mailbox without requiring full access.  The core functionality of your service can be expressed as scopes!!</li>
		<li>Allow a client to do something on the RO's behalf, without providing personally identifiable information to the client.</li>
	</ul>

	<h2>Demo</h2>
	<ul>
	  <li>OAuth 2.0 Implicit Grant Flow</li>
	  <li>JWT Access Tokens</li>
	  <li>Spring Boot is an application-bootstrapping framework that helps with the creation of Spring based applications with no necessary XML configuration or code generation.</li>
	  <li>Spring Security OAuth 2 Authorization Server</li>
	  <li>Resource Server (Lunch Items REST API):  C# or Node.js</li>
	  <li>AngularJS/sass/materialize??? client</li>
	  <li>User as the Resource Owner</li>
	  <li>In Implicit Grant Flow, the client secret is not used, as it cannot be kept confidential by a JavaScript app running in the browser.  (Can be decompiled, source code inspected, etc..)</li>
	</ul>
	<p>First, implement node.js/express.js Implicit Grant Flow example from OAuth 2 in Action, and then modify it to use the Spring Boot Authorization Server (AS) to issue JWT access tokens.</p>
	
    <h2>Slides: Interesting Visuals</h2>
    <ul>
      <li>Because tokens are so important in OAuth, the unofficial OAuth <a href="images/oauth_logo.png">logo</a> is modeled after a <a href="images/bus_token.jpg">bus token</a>.  (See OAuth 2 in Action, "11.1 What are OAuth Tokens?")</li>
      <li>Tokens for arcade games... (Include .mp3 of 80's ambient arcade noise?  Include game cabinets image.  Include token machine image and tokens image.).  Insert tokens in order to be granted limited access to the game.  You can play the game, but you cannot reset the high scores, etc..</li>
      <li>Slugs.  (Show electrical box image.)  Lore around my small school was that you could use slugs to trick the machine into letting you play the game.  It exploited a system vulnerability.  At an abstract level, you were forging an access token.</li>

    </ul>

    <h2>OAuth 2.0 Spec Highlights</h2>
    <ul>
      <li><a href="https://tools.ietf.org/html/rfc6749#section-3.1.2">3.1.2 Redirection Endpoint</a></li>
    </ul>

    <h2>OAuth 2.0 Validating Tokens</h2>
    <ul>
    	<li>A very common OAuth deployment pattern is using a shared database for the AS and RS.</li>
    	<li>There’s a standardized web protocol called Token Introspection that the authorization server can offer, allowing the resource server to check the token’s state at runtime.</li>
    </ul>

    <h2>Protecting a web API with OAuth</h2>
    <p>Protecting a web API with OAuth is fairly straightforward:</p>
    <ul>
    	<li>The token gets parsed out of the incoming request.</li>
    	<li>The token is validated with the authorization server.</li>
    	<li>The response is served based on what the token is good for.</li>
    </ul>

	<h2>OAuth Scopes</h2>
	<p>Information about serving user-specific data can be found in the following section of OAuth 2 in Action: Different users for different data results.  In the demo project, resources (lunch items) can be associated with specific employeeId values!!  (This is a very powerful design pattern, as it can protect the resource owner’s privacy by not revealing personally identifying information unnecessarily.)</p>
	<p>A scope is a permission.</p>
    <a href="http://docs.apigee.com/api-services/content/working-scopes">apigee: Working with OAuth2 Scopes</a><br />
	<a href="https://blogs.oracle.com/OracleIDM/entry/securing_access_with_oauth2_how">Article about OAuth2 scopes</a> (Also contains a good description of access tokens.)<br />
	<p>Figuring out what scopes to expose is a responsibility of an application developer, and it may be confusing at first:
    <ul>
        <li>Do I expose a single scope protecting the entire service, or do I expose scopes to protect fine-grained business functionality of my application?</li>
        <li>Do I break up my service into many smaller services with one scope each, or do I build multi-functional service with multiple fine-grained scopes?</li>
        <li>How do I balance the needs of my clients to request specific capabilities and the needs of my application owners to manage appropriate policies?</li>
    </ul>
    </p>
	
	<h2>General OAuth 2 Resources</h2>
	<a href="https://api.slack.com/docs/oauth">Using OAuth 2.0 (Slack)</a><br />
	
	<h2>Implicit Grant</h2>
	<ul>
		<li>In the Implicit Grant type, the client is in the browser.</li>
		<li>See Chapter 6 in OAuth 2 in Action</li>
	</ul>

	<h2>Blurb</h2>
	<ul>
	  <li>Learn techniques and technologies for guarding protected resources in systems composed of multiple distributed HTTP services.</li>
	</ul>
    </body>
</html>
